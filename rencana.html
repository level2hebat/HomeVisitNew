<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rencana Kunjungan - Sistem Kunjungan Rumah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Tambahkan SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }
      .pulse-success {
        animation: pulseSuccess 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulseSuccess {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
          background-color: #10b981;
        }
        100% {
          transform: scale(1);
        }
      }

      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
      }
      .notification.show {
        transform: translateX(0);
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-purple-50 via-indigo-50 to-blue-50 min-h-screen"
  >
    <!-- Notification Toast -->
    <div
      id="notification"
      class="notification bg-white rounded-lg shadow-lg p-4 max-w-sm"
    >
      <div class="flex items-center">
        <div
          id="notificationIcon"
          class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3"
        >
          <!-- Icon will be inserted here -->
        </div>
        <div>
          <p id="notificationTitle" class="font-medium text-gray-900"></p>
          <p id="notificationMessage" class="text-sm text-gray-600"></p>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-lg border-b sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center">
            <div
              class="bg-gradient-to-r from-purple-600 to-indigo-600 w-10 h-10 rounded-lg flex items-center justify-center mr-3"
            >
              <svg
                class="w-6 h-6 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4l2 2 4-4"
                ></path>
              </svg>
            </div>
            <div>
              <h1
                class="text-lg sm:text-xl md:text-2xl font-bold text-gray-900"
              >
                Rencana Kunjungan
              </h1>
              <p class="text-xs sm:text-sm text-gray-600 hidden sm:block">
                Rencanakan kunjungan rumah -
                <span id="currentTeacher" class="font-medium"></span>
              </p>
            </div>
          </div>

          <!-- Mobile Menu Button -->
          <div class="md:hidden">
            <button
              onclick="toggleMobileMenu()"
              class="text-gray-600 hover:text-gray-900 focus:outline-none"
            >
              <svg
                id="menuIcon"
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                ></path>
              </svg>
            </button>
          </div>

          <!-- Desktop Navigation -->
          <div class="hidden md:flex items-center space-x-4">
            <div id="syncStatus" class="flex items-center text-sm mr-4">
              <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
              <span class="text-gray-600">Online</span>
            </div>
            <button
              onclick="goToForm()"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
            >
              <span class="flex items-center">
                <svg
                  class="w-4 h-4 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                  ></path>
                </svg>
                Form Baru
              </span>
            </button>
            <button
              onclick="goToHistory()"
              class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
            >
              <span class="flex items-center">
                <svg
                  class="w-4 h-4 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
                Riwayat
              </span>
            </button>
            <button
              onclick="logout()"
              class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors"
            >
              Keluar
            </button>
          </div>
        </div>

        <!-- Mobile Navigation Menu -->
        <div
          id="mobileMenu"
          class="md:hidden hidden border-t border-gray-200 py-4"
        >
          <div class="space-y-4">
            <div id="syncStatusMobile" class="flex items-center text-sm px-2">
              <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
              <span class="text-gray-600">Online</span>
            </div>
            <div class="text-sm text-gray-600 px-2">
              <span class="font-medium" id="currentTeacherMobile"></span>
            </div>
            <button
              onclick="goToForm()"
              class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors"
            >
              <span class="flex items-center justify-center">
                <svg
                  class="w-4 h-4 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                  ></path>
                </svg>
                Form Kunjungan Baru
              </span>
            </button>
            <button
              onclick="goToHistory()"
              class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors"
            >
              <span class="flex items-center justify-center">
                <svg
                  class="w-4 h-4 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
                Riwayat Kunjungan
              </span>
            </button>
            <button
              onclick="logout()"
              class="w-full bg-red-500 text-white px-4 py-3 rounded-lg hover:bg-red-600 transition-colors"
            >
              <span class="flex items-center justify-center">
                <svg
                  class="w-4 h-4 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                  ></path>
                </svg>
                Keluar dari Sistem
              </span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <div class="max-w-6xl mx-auto p-4 py-6 sm:py-8">
      <!-- Form Rencana -->
      <div
        class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 md:p-8 card-hover fade-in mb-8"
      >
        <div class="flex flex-col sm:flex-row sm:items-center mb-6">
          <div
            class="bg-purple-100 p-3 rounded-lg mr-0 sm:mr-4 mb-3 sm:mb-0 self-start"
          >
            <svg
              class="w-6 h-6 text-purple-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6v6m0 0v6m0-6h6m-6 0H6"
              ></path>
            </svg>
          </div>
          <div>
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800">
              Tambah Rencana Kunjungan
            </h2>
            <p class="text-sm sm:text-base text-gray-600">
              Buat rencana kunjungan rumah siswa
            </p>
          </div>
        </div>

        <form id="planForm" class="space-y-4 sm:space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="flex items-center">
                  <svg
                    class="w-4 h-4 mr-2 text-purple-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4l2 2 4-4"
                    ></path>
                  </svg>
                  Tanggal Rencana
                </span>
              </label>
              <input
                type="date"
                id="planDate"
                class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                required
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="flex items-center">
                  <svg
                    class="w-4 h-4 mr-2 text-purple-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>
                  Waktu Rencana
                </span>
              </label>
              <input
                type="time"
                id="planTime"
                class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                required
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <span class="flex items-center">
                <svg
                  class="w-4 h-4 mr-2 text-purple-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  ></path>
                </svg>
                Nama Siswa
              </span>
            </label>
            <input
              type="text"
              id="studentName"
              class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
              placeholder="Masukkan nama lengkap siswa"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <span class="flex items-center">
                <svg
                  class="w-4 h-4 mr-2 text-purple-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                  ></path>
                </svg>
                Tujuan Kunjungan
              </span>
            </label>
            <select
              id="visitPurpose"
              class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent appearance-none bg-white transition-all"
              required
            >
              <option value="">Pilih Tujuan</option>
              <option value="Konsultasi Akademik">
                📚 Konsultasi Akademik
              </option>
              <option value="Konsultasi Perilaku">
                👥 Konsultasi Perilaku
              </option>
              <option value="Kunjungan Rutin">🏠 Kunjungan Rutin</option>
              <option value="Masalah Kehadiran">📅 Masalah Kehadiran</option>
              <option value="Koordinasi Orang Tua">
                👨‍👩‍👧‍👦 Koordinasi Orang Tua
              </option>
              <option value="Lainnya">📝 Lainnya</option>
            </select>
          </div>

          <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 pt-4 sm:pt-6">
            <button
              type="submit"
              class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 sm:py-3 px-4 sm:px-6 rounded-lg font-medium hover:from-purple-700 hover:to-indigo-700 transition-all duration-300 transform hover:scale-105 text-sm sm:text-base"
            >
              <span class="flex items-center justify-center">
                <svg
                  class="w-4 h-4 sm:w-5 sm:h-5 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  ></path>
                </svg>
                Simpan Rencana
              </span>
            </button>
            <button
              type="button"
              onclick="resetForm()"
              class="sm:w-auto bg-gray-200 text-gray-700 py-3 sm:py-3 px-4 sm:px-6 rounded-lg font-medium hover:bg-gray-300 transition-colors text-sm sm:text-base"
            >
              <span class="flex items-center justify-center">
                <svg
                  class="w-4 h-4 sm:w-5 sm:h-5 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  ></path>
                </svg>
                Reset Form
              </span>
            </button>
          </div>
        </form>
      </div>

      <!-- Daftar Rencana -->
      <div
        class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 md:p-8 card-hover fade-in"
      >
        <div
          class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"
        >
          <div class="flex items-center">
            <div class="bg-purple-100 p-3 rounded-lg mr-4">
              <svg
                class="w-6 h-6 text-purple-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                ></path>
              </svg>
            </div>
            <div>
              <h2 class="text-xl sm:text-2xl font-bold text-gray-800">
                Daftar Rencana
              </h2>
              <p class="text-sm sm:text-base text-gray-600">
                Rencana kunjungan yang akan datang
              </p>
            </div>
          </div>

          <button
            onclick="refreshPlans()"
            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors flex items-center"
          >
            <svg
              class="w-4 h-4 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              ></path>
            </svg>
            Refresh
          </button>
        </div>

        <div id="plansList" class="space-y-4">
          <div class="text-center py-12">
            <svg
              class="w-16 h-16 text-gray-300 mx-auto mb-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4l2 2 4-4"
              ></path>
            </svg>
            <p class="text-gray-500 text-lg">Memuat rencana...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div
      id="editModal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="p-6 border-b">
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-bold text-gray-800">
              Edit Rencana Kunjungan
            </h3>
            <button
              onclick="closeEditModal()"
              class="text-gray-400 hover:text-gray-600 transition-colors"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
        </div>
        <div class="p-6">
          <form id="editForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Tanggal Rencana</label
                >
                <input
                  type="date"
                  id="editPlanDate"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  required
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Waktu Rencana</label
                >
                <input
                  type="time"
                  id="editPlanTime"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  required
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Nama Siswa</label
              >
              <input
                type="text"
                id="editStudentName"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                required
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Tujuan Kunjungan</label
              >
              <select
                id="editVisitPurpose"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                required
              >
                <option value="">Pilih Tujuan</option>
                <option value="Konsultasi Akademik">
                  📚 Konsultasi Akademik
                </option>
                <option value="Konsultasi Perilaku">
                  👥 Konsultasi Perilaku
                </option>
                <option value="Kunjungan Rutin">🏠 Kunjungan Rutin</option>
                <option value="Masalah Kehadiran">📅 Masalah Kehadiran</option>
                <option value="Koordinasi Orang Tua">
                  👨‍👩‍👧‍👦 Koordinasi Orang Tua
                </option>
                <option value="Lainnya">📝 Lainnya</option>
              </select>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 pt-6">
              <button
                type="submit"
                class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 px-6 rounded-lg font-medium hover:from-purple-700 hover:to-indigo-700 transition-all duration-300"
              >
                <span class="flex items-center justify-center">
                  <svg
                    class="w-5 h-5 mr-2"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"
                    ></path>
                  </svg>
                  Simpan Perubahan
                </span>
              </button>
              <button
                type="button"
                onclick="closeEditModal()"
                class="sm:w-auto bg-gray-200 text-gray-700 py-3 px-6 rounded-lg font-medium hover:bg-gray-300 transition-colors"
              >
                Batal
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let currentUser = "";
      let supabase = null;
      let plansData = [];
      let editingPlanId = null;

      // Initialize app
      document.addEventListener("DOMContentLoaded", function () {
        checkAuth();
        initializeSupabase();
        setupEventListeners();
        loadPlans();

        // Set default date to today
        document.getElementById("planDate").valueAsDate = new Date();
      });

      function checkAuth() {
        currentUser = localStorage.getItem("currentUser");
        const loginTime = localStorage.getItem("loginTime");

        if (!currentUser || !loginTime) {
          window.location.href = "index.html";
          return;
        }

        // Check if login is still valid (24 hours)
        const loginDate = new Date(loginTime);
        const now = new Date();
        const hoursDiff = (now - loginDate) / (1000 * 60 * 60);

        if (hoursDiff >= 24) {
          localStorage.removeItem("currentUser");
          localStorage.removeItem("loginTime");
          window.location.href = "index.html";
          return;
        }

        document.getElementById("currentTeacher").textContent = currentUser;
        document.getElementById("currentTeacherMobile").textContent =
          currentUser;
      }

      function toggleMobileMenu() {
        const mobileMenu = document.getElementById("mobileMenu");
        const menuIcon = document.getElementById("menuIcon");

        if (mobileMenu.classList.contains("hidden")) {
          mobileMenu.classList.remove("hidden");
          menuIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                `;
        } else {
          mobileMenu.classList.add("hidden");
          menuIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                `;
        }
      }

      function initializeSupabase() {
        const supabaseUrl = "https://zywlolvaejlrfimxrjvi.supabase.co";
        const supabaseKey =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5d2xvbHZhZWpscmZpbXhyanZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTUxNzIsImV4cCI6MjA3MTY3MTE3Mn0.Go7Vf8yD35aN_xFKMN3tS9NlgBAkFXCoS-bmVX7n_pk";

        try {
          supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
          updateSyncStatus("online", "Online");
        } catch (error) {
          console.error("Error initializing Supabase:", error);
          updateSyncStatus("offline", "Offline");
        }
      }

      function setupEventListeners() {
        document
          .getElementById("planForm")
          .addEventListener("submit", handlePlanSubmit);
        document
          .getElementById("editForm")
          .addEventListener("submit", handleEditSubmit);
      }

      function updateSyncStatus(status, message) {
        const syncStatusElement = document.getElementById("syncStatus");
        const syncStatusMobileElement =
          document.getElementById("syncStatusMobile");

        const statusHTML =
          status === "online"
            ? `
                <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                <span class="text-gray-600">${message}</span>
            `
            : `
                <div class="w-2 h-2 bg-orange-400 rounded-full mr-2"></div>
                <span class="text-gray-600">${message}</span>
            `;

        if (syncStatusElement) {
          syncStatusElement.innerHTML = statusHTML;
        }
        if (syncStatusMobileElement) {
          syncStatusMobileElement.innerHTML = statusHTML;
        }
      }

      async function handlePlanSubmit(e) {
        e.preventDefault();

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;

        // Show loading state
        submitBtn.innerHTML = `
                <span class="flex items-center justify-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Menyimpan...
                </span>
            `;
        submitBtn.disabled = true;

        try {
          const planRecord = {
            teacher: currentUser,
            plan_date: document.getElementById("planDate").value,
            plan_time: document.getElementById("planTime").value,
            student_name: document.getElementById("studentName").value,
            visit_purpose: document.getElementById("visitPurpose").value,
            status: "planned",
          };

          if (supabase) {
            // Save to Supabase - menggunakan tabel 'plans' seperti 'visits'
            const { data, error } = await supabase
              .from("plans")
              .insert([planRecord])
              .select();

            if (error) {
              throw error;
            }

            showNotification(
              "success",
              "Rencana Tersimpan",
              `Rencana kunjungan ke ${planRecord.student_name} berhasil disimpan ke Supabase`
            );
          } else {
            // Save to localStorage as fallback
            planRecord.id = Date.now();
            planRecord.created_at = new Date().toISOString();

            const existingData =
              JSON.parse(localStorage.getItem("visitPlans")) || [];
            existingData.push(planRecord);
            localStorage.setItem("visitPlans", JSON.stringify(existingData));

            showNotification(
              "success",
              "Rencana Tersimpan",
              `Rencana kunjungan ke ${planRecord.student_name} berhasil disimpan secara lokal`
            );
          }

          // Reset form and reload plans
          document.getElementById("planForm").reset();
          document.getElementById("planDate").valueAsDate = new Date();
          await loadPlans();
        } catch (error) {
          console.error("Error saving plan:", error);
          showNotification(
            "error",
            "Gagal Menyimpan",
            "Terjadi kesalahan saat menyimpan rencana"
          );
        } finally {
          // Reset button
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
          submitBtn.classList.add("pulse-success");

          setTimeout(() => {
            submitBtn.classList.remove("pulse-success");
          }, 500);
        }
      }

      async function loadPlans() {
        try {
          if (supabase) {
            // Load from Supabase - menggunakan tabel 'plans' dan filter berdasarkan teacher
            const { data, error } = await supabase
              .from("plans")
              .select("*")
              .eq("teacher", currentUser)
              .order("plan_date", { ascending: true })
              .order("plan_time", { ascending: true });

            if (error) {
              throw error;
            }

            plansData = data || [];
            console.log(
              `Loaded ${plansData.length} plans for teacher: ${currentUser}`
            );
          } else {
            // Load from localStorage as fallback - filter by current teacher
            const allData =
              JSON.parse(localStorage.getItem("visitPlans")) || [];
            plansData = allData.filter((plan) => plan.teacher === currentUser);
            console.log(
              `Loaded ${plansData.length} plans from localStorage for teacher: ${currentUser}`
            );
          }

          displayPlans(plansData);
        } catch (error) {
          console.error("Error loading plans:", error);
          // Fallback to localStorage
          const allData = JSON.parse(localStorage.getItem("visitPlans")) || [];
          plansData = allData.filter((plan) => plan.teacher === currentUser);
          displayPlans(plansData);
          showNotification(
            "error",
            "Gagal Memuat",
            "Menggunakan data lokal sebagai cadangan"
          );
        }
      }

      function displayPlans(plans) {
        const plansContainer = document.getElementById("plansList");

        if (plans.length === 0) {
          plansContainer.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4l2 2 4-4"></path>
                        </svg>
                        <p class="text-gray-500 text-lg">Tidak ada rencana kunjungan</p>
                        <p class="text-gray-400 text-sm mt-2">Mulai dengan membuat rencana baru</p>
                    </div>
                `;
          return;
        }

        const purposeIcons = {
          "Konsultasi Akademik": "📚",
          "Konsultasi Perilaku": "👥",
          "Kunjungan Rutin": "🏠",
          "Masalah Kehadiran": "📅",
          "Koordinasi Orang Tua": "👨‍👩‍👧‍👦",
          Lainnya: "📝",
        };

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        plansContainer.innerHTML = plans
          .map((plan) => {
            const planDate = new Date(plan.plan_date);
            planDate.setHours(0, 0, 0, 0);

            const isOverdue = planDate < today;
            const isToday = planDate.getTime() === today.getTime();

            let statusClass = "bg-blue-100 text-blue-800";
            let statusText = "Direncanakan";

            if (isOverdue) {
              statusClass = "bg-red-100 text-red-800";
              statusText = "Terlewat";
            } else if (isToday) {
              statusClass = "bg-green-100 text-green-800";
              statusText = "Hari Ini";
            }

            return `
                    <div class="border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-all duration-300 card-hover bg-gradient-to-r from-white to-purple-50">
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                            <div class="flex items-center mb-2 md:mb-0">
                                <div class="bg-purple-100 p-2 rounded-lg mr-3">
                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800 text-lg">${
                                      plan.student_name
                                    }</h3>
                                    <span class="inline-block px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                            <div class="flex items-center text-sm text-gray-500">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4l2 2 4-4"></path>
                                </svg>
                                ${new Date(plan.plan_date).toLocaleDateString(
                                  "id-ID",
                                  {
                                    weekday: "long",
                                    year: "numeric",
                                    month: "long",
                                    day: "numeric",
                                  }
                                )}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="flex items-center">
                                <span class="text-lg mr-2">${
                                  purposeIcons[plan.visit_purpose] || "📝"
                                }</span>
                                <span class="text-sm text-gray-600">${
                                  plan.visit_purpose
                                }</span>
                            </div>
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="text-sm text-gray-600">${
                                  plan.plan_time
                                }</span>
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button onclick="editPlan(${
                              plan.id
                            })" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Edit
                            </button>
                            <button onclick="markAsCompleted(${
                              plan.id
                            })" class="sm:w-auto bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Selesai
                            </button>
                            <button onclick="deletePlan(${
                              plan.id
                            })" class="sm:w-auto bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Hapus
                            </button>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function editPlan(planId) {
        const plan = plansData.find((p) => p.id === planId);
        if (plan && plan.teacher === currentUser) {
          editingPlanId = planId;

          // Populate form with existing data
          document.getElementById("editPlanDate").value = plan.plan_date;
          document.getElementById("editPlanTime").value = plan.plan_time;
          document.getElementById("editStudentName").value = plan.student_name;
          document.getElementById("editVisitPurpose").value =
            plan.visit_purpose;

          document.getElementById("editModal").classList.remove("hidden");
        } else {
          showNotification(
            "error",
            "Akses Ditolak",
            "Anda hanya dapat mengedit rencana Anda sendiri"
          );
        }
      }

      function closeEditModal() {
        document.getElementById("editModal").classList.add("hidden");
        editingPlanId = null;
      }

      async function handleEditSubmit(e) {
        e.preventDefault();

        if (!editingPlanId) return;

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;

        // Show loading state
        submitBtn.innerHTML = `
                <span class="flex items-center justify-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Menyimpan...
                </span>
            `;
        submitBtn.disabled = true;

        try {
          const updatedPlan = {
            plan_date: document.getElementById("editPlanDate").value,
            plan_time: document.getElementById("editPlanTime").value,
            student_name: document.getElementById("editStudentName").value,
            visit_purpose: document.getElementById("editVisitPurpose").value,
          };

          if (supabase) {
            // Update in Supabase dengan filter teacher untuk keamanan
            const { data, error } = await supabase
              .from("plans")
              .update(updatedPlan)
              .eq("id", editingPlanId)
              .eq("teacher", currentUser)
              .select();

            if (error) {
              throw error;
            }

            if (data && data.length === 0) {
              throw new Error(
                "Data tidak ditemukan atau Anda tidak memiliki akses"
              );
            }
          } else {
            // Update in localStorage
            const allData =
              JSON.parse(localStorage.getItem("visitPlans")) || [];
            const planIndex = allData.findIndex(
              (plan) =>
                plan.id === editingPlanId && plan.teacher === currentUser
            );

            if (planIndex === -1) {
              throw new Error(
                "Data tidak ditemukan atau Anda tidak memiliki akses"
              );
            }

            allData[planIndex] = { ...allData[planIndex], ...updatedPlan };
            localStorage.setItem("visitPlans", JSON.stringify(allData));
          }

          await loadPlans();
          closeEditModal();
          showNotification(
            "success",
            "Rencana Diperbarui",
            `Rencana kunjungan ${updatedPlan.student_name} berhasil diperbarui`
          );
        } catch (error) {
          console.error("Error updating plan:", error);
          showNotification(
            "error",
            "Gagal Memperbarui",
            error.message || "Terjadi kesalahan saat memperbarui rencana"
          );
        } finally {
          // Reset button
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }

      async function markAsCompleted(planId) {
        const plan = plansData.find((p) => p.id === planId);
        if (!plan || plan.teacher !== currentUser) {
          showNotification(
            "error",
            "Akses Ditolak",
            "Anda hanya dapat menyelesaikan rencana Anda sendiri"
          );
          return;
        }

        if (
          confirm(
            `Tandai rencana kunjungan ke ${plan.student_name} sebagai selesai?`
          )
        ) {
          // Redirect to form page with pre-filled data
          localStorage.setItem("prefilledPlan", JSON.stringify(plan));
          window.location.href = "form.html";
        }
      }

      async function deletePlan(planId) {
        const planToDelete = plansData.find((plan) => plan.id === planId);
        if (!planToDelete || planToDelete.teacher !== currentUser) {
          Swal.fire({
            icon: "error",
            title: "Akses Ditolak",
            text: "Anda hanya dapat menghapus rencana Anda sendiri",
            confirmButtonColor: "#d33",
          });
          return;
        }

        Swal.fire({
          title: "Yakin hapus rencana?",
          text: "Rencana ini tidak bisa dikembalikan setelah dihapus!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Ya, hapus!",
          cancelButtonText: "Batal",
        }).then(async (result) => {
          if (result.isConfirmed) {
            try {
              if (supabase) {
                const { error } = await supabase
                  .from("plans")
                  .delete()
                  .eq("id", planId)
                  .eq("teacher", currentUser);
                if (error) throw error;
              } else {
                const allData =
                  JSON.parse(localStorage.getItem("visitPlans")) || [];
                const updatedData = allData.filter(
                  (plan) => plan.id !== planId || plan.teacher !== currentUser
                );
                localStorage.setItem("visitPlans", JSON.stringify(updatedData));
              }

              await loadPlans();

              Swal.fire({
                icon: "success",
                title: "Berhasil!",
                text: "Rencana kunjungan berhasil dihapus",
                confirmButtonColor: "#3085d6",
              });
            } catch (error) {
              console.error("Error deleting plan:", error);
              Swal.fire({
                icon: "error",
                title: "Gagal",
                text: "Terjadi kesalahan saat menghapus rencana",
                confirmButtonColor: "#d33",
              });
            }
          }
        });
      }

      function resetForm() {
        if (confirm("Apakah Anda yakin ingin mengosongkan form?")) {
          document.getElementById("planForm").reset();
          document.getElementById("planDate").valueAsDate = new Date();
          showNotification("success", "Form Direset", "Form telah dikosongkan");
        }
      }

      async function refreshPlans() {
        await loadPlans();
        showNotification(
          "success",
          "Data Diperbarui",
          "Daftar rencana telah diperbarui"
        );
      }

      function goToForm() {
        window.location.href = "form.html";
      }

      function goToHistory() {
        window.location.href = "riwayat.html";
      }

      function logout() {
        Swal.fire({
          title: "Yakin ingin keluar?",
          text: "Anda akan keluar dari sistem",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Ya, keluar",
          cancelButtonText: "Batal",
        }).then((result) => {
          if (result.isConfirmed) {
            localStorage.removeItem("currentUser");
            localStorage.removeItem("loginTime");

            Swal.fire({
              icon: "success",
              title: "Berhasil keluar",
              text: "Anda akan diarahkan ke halaman login",
              timer: 1500,
              showConfirmButton: false,
            }).then(() => {
              window.location.href = "index.html";
            });
          }
        });
      }

      function showNotification(type, title, message) {
        const notification = document.getElementById("notification");
        const icon = document.getElementById("notificationIcon");
        const titleEl = document.getElementById("notificationTitle");
        const messageEl = document.getElementById("notificationMessage");

        titleEl.textContent = title;
        messageEl.textContent = message;

        if (type === "success") {
          icon.className =
            "flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3 bg-green-100";
          icon.innerHTML =
            '<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
        } else if (type === "error") {
          icon.className =
            "flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3 bg-red-100";
          icon.innerHTML =
            '<svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
        }

        notification.classList.add("show");

        setTimeout(() => {
          notification.classList.remove("show");
        }, 3000);
      }

      // Close modal when clicking outside
      document
        .getElementById("editModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeEditModal();
          }
        });
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'974976dc14baa24f',t:'MTc1NjEwNzg2Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
